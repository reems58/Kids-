<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ© - Ù…Ø«Ø§Ù„</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        .task-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .task-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .task-info {
            flex: 1;
        }
        .task-actions {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-up { background: #10b981; color: white; }
        .btn-down { background: #6366f1; color: white; }
        .btn-delete { background: #ef4444; color: white; }
        .btn:hover { transform: translateY(-2px); }
        .add-task-form {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }
        .loading {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="task-container">
        <h1>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</h1>
        
        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© -->
        <div class="add-task-form">
            <h2>Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <form id="addTaskForm">
                <div class="form-group">
                    <label>Ù…Ø¹Ø±Ù Ø§Ù„Ø·ÙÙ„:</label>
                    <input type="number" id="childId" required>
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</label>
                    <select id="contentSelect" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù‡Ù…Ø© (Ø¹Ø±Ø¨ÙŠ):</label>
                    <input type="text" id="taskNameAr" placeholder="Ù…Ø«Ø§Ù„: ØªØ¹Ù„Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù…">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¯Ø© (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚):</label>
                    <input type="number" id="duration" value="10" min="1">
                </div>
                <div class="form-group">
                    <label>Ø§Ù„ØªØ±ØªÙŠØ¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ù„Ù„Ø¥Ø¶Ø§ÙØ© ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©):</label>
                    <input type="number" id="orderIndex" min="0">
                </div>
                <button type="submit" class="btn" style="background: #6366f1; color: white;">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©</button>
            </form>
        </div>

        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù‡Ø§Ù… -->
        <div id="tasksList">
            <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</div>
        </div>
    </div>

    <script src="../js/task_manager.js"></script>
    <script>
        let currentChildId = null;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ØªØ§Ø­
        async function loadContent() {
            try {
                const content = await TaskManager.getAllContent();
                const select = document.getElementById('contentSelect');
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø­ØªÙˆÙ‰...</option>';
                content.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.content_id;
                    option.textContent = item.content_name_ar;
                    select.appendChild(option);
                });
            } catch (error) {
                TaskManager.showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰: ' + error.message);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…
        async function loadTasks(childId) {
            const tasksList = document.getElementById('tasksList');
            tasksList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…...</div>';
            
            try {
                const tasks = await TaskManager.getChildTasks(childId);
                
                if (tasks.length === 0) {
                    tasksList.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                    return;
                }
                
                tasksList.innerHTML = '';
                tasks.forEach((task, index) => {
                    const taskCard = document.createElement('div');
                    taskCard.className = 'task-card';
                    taskCard.innerHTML = `
                        <div class="task-info">
                            <h3>${task.task_name_ar || task.task_name}</h3>
                            <p><strong>Ø§Ù„Ù…Ø­ØªÙˆÙ‰:</strong> ${task.content_name_ar}</p>
                            <p><strong>Ø§Ù„Ù…Ø¯Ø©:</strong> ${task.duration_minutes} Ø¯Ù‚ÙŠÙ‚Ø©</p>
                            <p><strong>Ø§Ù„ØªØ±ØªÙŠØ¨:</strong> ${task.order_index}</p>
                            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${task.status}</p>
                            ${task.description ? `<p>${task.description}</p>` : ''}
                        </div>
                        <div class="task-actions">
                            <button class="btn btn-up" onclick="moveTaskUp(${task.task_id})" ${index === 0 ? 'disabled' : ''}>
                                â¬†ï¸ Ø£Ø¹Ù„Ù‰
                            </button>
                            <button class="btn btn-down" onclick="moveTaskDown(${task.task_id})" ${index === tasks.length - 1 ? 'disabled' : ''}>
                                â¬‡ï¸ Ø£Ø³ÙÙ„
                            </button>
                            <button class="btn btn-delete" onclick="deleteTask(${task.task_id})">
                                ğŸ—‘ï¸ Ø­Ø°Ù
                            </button>
                        </div>
                    `;
                    tasksList.appendChild(taskCard);
                });
            } catch (error) {
                tasksList.innerHTML = `<p style="color: red;">Ø®Ø·Ø£: ${error.message}</p>`;
                TaskManager.showError('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…: ' + error.message);
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø©
        document.getElementById('addTaskForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const childId = parseInt(document.getElementById('childId').value);
            const contentId = parseInt(document.getElementById('contentSelect').value);
            const taskNameAr = document.getElementById('taskNameAr').value;
            const duration = parseInt(document.getElementById('duration').value) || 10;
            const orderIndex = document.getElementById('orderIndex').value ? 
                parseInt(document.getElementById('orderIndex').value) : null;
            
            if (!childId || !contentId) {
                TaskManager.showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¹Ø±Ù Ø§Ù„Ø·ÙÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
                return;
            }
            
            try {
                const taskData = {
                    child_id: childId,
                    content_id: contentId,
                    task_name_ar: taskNameAr,
                    duration_minutes: duration
                };
                
                if (orderIndex !== null) {
                    taskData.order_index = orderIndex;
                }
                
                await TaskManager.addTask(taskData);
                TaskManager.showSuccess('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
                
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…
                if (currentChildId) {
                    await loadTasks(currentChildId);
                }
                
                // Ù…Ø³Ø­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
                document.getElementById('addTaskForm').reset();
            } catch (error) {
                TaskManager.showError('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©: ' + error.message);
            }
        });

        // Ù†Ù‚Ù„ Ù…Ù‡Ù…Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰
        async function moveTaskUp(taskId) {
            try {
                await TaskManager.moveTaskUp(taskId);
                TaskManager.showSuccess('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰');
                if (currentChildId) {
                    await loadTasks(currentChildId);
                }
            } catch (error) {
                TaskManager.showError('ÙØ´Ù„ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©: ' + error.message);
            }
        }

        // Ù†Ù‚Ù„ Ù…Ù‡Ù…Ø© Ù„Ù„Ø£Ø³ÙÙ„
        async function moveTaskDown(taskId) {
            try {
                await TaskManager.moveTaskDown(taskId);
                TaskManager.showSuccess('ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ù…Ø© Ù„Ù„Ø£Ø³ÙÙ„');
                if (currentChildId) {
                    await loadTasks(currentChildId);
                }
            } catch (error) {
                TaskManager.showError('ÙØ´Ù„ Ù†Ù‚Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©: ' + error.message);
            }
        }

        // Ø­Ø°Ù Ù…Ù‡Ù…Ø©
        async function deleteTask(taskId) {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) {
                return;
            }
            
            try {
                await TaskManager.deleteTask(taskId);
                TaskManager.showSuccess('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­');
                if (currentChildId) {
                    await loadTasks(currentChildId);
                }
            } catch (error) {
                TaskManager.showError('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©: ' + error.message);
            }
        }

        // Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù…Ø¹Ø±Ù Ø§Ù„Ø·ÙÙ„ØŒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù…
        document.getElementById('childId').addEventListener('change', (e) => {
            const childId = parseInt(e.target.value);
            if (childId) {
                currentChildId = childId;
                loadTasks(childId);
            }
        });

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        loadContent();
    </script>
</body>
</html>

